<link rel="import" href="plotly-import.html">
<script>
    window.PlotlyBehaviours = window.PlotlyPlotlyBehaviours || {};
    PlotlyBehaviours = {
        // Update the plot to reflect new data
        /**
        * Redraw the plot using the current state of the widget's properties.
        *
        * This should happen automatically if you use `.set`, but if you want to
        * do a lot of manipulation in multiple steps and then redraw at the end,
        * call this method.
        *
        * @return {Promise<Polymer.Base>}
        *  a Promise for the asynchronous plot update that resolves to the
        *  Polymer element.
        *
        * @see the {@link https://plot.ly/javascript/plotlyjs-function-reference/|plotly.js function reference}
        */
        redraw: function () {
            var self = this;

            // XXX For some reason, this class gets removed and plotly.js complains
            self.toggleClass('js-plotly-plot', true, self.$.plot);

            // Set the plot data, layout, and config state to reflect the current
            // state of the polymer properties
            self.$.plot.data = self.data;
            self.$.plot.layout = self.layout;
            self.$.plot.config = self.config;

            return Plotly.redraw(self.$.plot).then(function () {
            // Remove any tasks waiting to go; prevent any further debounced
            // redraws
            self.cancelDebouncer('autoRedraw');

            return self;
            });
      },

      /**
       * Automatically redraw the plot on data updates, if not manual.
       * Debounces the .redraw call.
       */
      _autoRedraw: function () {
        if (typeof self.manual !== 'undefined' && !self.manual) {
          // Limit the frequency of redraw tasks by putting them in a
          // debounce queue
          this.debounce(
            'autoRedraw',
            this.redraw.bind(this),
            this.debounceInterval
          );
        }

        return;
      },

      /**
       * Restyle the plot with updates to all (or a specified subset of) the
       * traces.
       *
       * @param {Object<string,*|Array>}
       *  an object whose keys are normal trace keys, and whose values are
       *  either regular keys, or array versions of the normal trace object
       *  values: one value in the array will be applied to each of the traces
       *  in the `traceIndices` argument.
       * @param {number|Array<number>}
       *  a single index, or an array of indices of traces (the elements of
       *  `.data`) on which to apply the styles
       *
       * @return {Promise<Polymer.Base>}
       *  a Promise for the asynchronous plot update that resolves to the
       *  Polymer element.
       *
       * @see the {@link https://plot.ly/javascript/plotlyjs-function-reference/|plotly.js function reference}
       */
      restyle: function (style, traceIndices) {
        var self = this;
        return Plotly.restyle(self.$.plot, style, traceIndices)
          .then(function (plotDiv) {
            // Update the polymer properties to reflect the updated data
            self.data = plotDiv.data;
            return self;
          });
      },

      /**
       * Update the plot layout.
       *
       * @param {Object} layoutUpdate
       *  the data to change in the `layout` property
       *
       * @return {Promise<Polymer.Base>}
       *  a Promise for the asynchronous plot update that resolves to the
       *  Polymer element.
       *
       * @see the {@link https://plot.ly/javascript/plotlyjs-function-reference/|plotly.js function reference}
       */
      relayout: function (layoutUpdate) {
        var self = this;
        return Plotly.relayout(self.$.plot, layoutUpdate)
          .then(function (plotDiv) {
            var oldManual;

            // Remove any debounced relayout tasks waiting to go;
            // prevent any further relayouts
            self.cancelDebouncer('autoRelayout');

            // Update the Polymer properties to reflect the updated data without
            // triggering any new relayout calls.
            oldManual = self.manual;
            self.manual = true;
            self.layout = plotDiv.layout;
            self.manual = oldManual;

            return self;
          });
      },

      /**
       * Automatically redraw the plot on layout updates, if not manual.
       * Debounces the `.relayout` call.
       *
       * @param {Object} layoutUpdate
       *  the data to change in the `layout` property
       */
      _autoRelayout: function (layoutUpdate) {
        var self = this;

        if (typeof self.manual !== 'undefined' && !self.manual) {
          // Limit the frequency of relayout tasks by putting them in a
          // debounce queue
          self.debounce(
            'autoRelayout',
            function () { self.relayout(layoutUpdate); },
            self.debounceInterval
          );
        }

        return;
      },


      // Manipulate traces

      /**
       * Add traces to the plot in the specified indices, if provided.
       *
       * @param {(Object|Array<Object>)} traces
       *  an individual trace, as an object of trace information, or an array
       *  of those traces
       * @param {(number|Array<number>)=} traceIndices
       *  an individual index or an array of indices specifying where to add
       *  the traces
       *
       * @return {Promise<Polymer.Base>}
       *  a Promise for the asynchronous plot update that resolves to the
       *  Polymer element.
       *
       * @see the {@link https://plot.ly/javascript/plotlyjs-function-reference/|plotly.js function reference}
       */
      addTraces: function (traces, traceIndices) {
        var self = this;
        return Plotly.addTraces(self.$.plot, traces, traceIndices)
          .then(function (plotDiv) {
            // Update the polymer properties to reflect the updated data
            self.data = plotDiv.data;
            return self;
          });
      },

      /**
       * Delete the specified traces from the plot.
       *
       * @param {(number|Array<number>)=} traceIndices
       *  an individual index or an array of indices specifying which traces to
       *  delete
       *
       * @return {Promise<Polymer.Base>}
       *  a Promise for the asynchronous plot update that resolves to the
       *  Polymer element.

       * @see the {@link https://plot.ly/javascript/plotlyjs-function-reference/|plotly.js function reference}
       */
      deleteTraces: function (traceIndices) {
        var self = this;
        return Plotly.deleteTraces(self.$.plot, traceIndices)
          .then(function (plotDiv) {
            // Update the polymer properties to reflect the updated data
            self.data = plotDiv.data;

            return self;
          });
      },

      /**
       * Move a specified set traces from the plot to a newly specified set of
       * destination trace positions.
       *
       * @param {(number|Array<number>)=} traceIndicesFrom
       *  an individual index or an array of indices specifying which traces to
       *  move
       * @param {(number|Array<number>)=} traceIndicesTo
       *  an individual index or an array of indices specifying where the
       *  traces should move
       *
       * @return {Promise<Polymer.Base>}
       *  a Promise for the asynchronous plot update that resolves to the
       *  Polymer element.
       *
       * @see the {@link https://plot.ly/javascript/plotlyjs-function-reference/|plotly.js function reference}
       */
      moveTraces: function (traceIndicesFrom, traceIndicesTo) {
        var self = this;

        return Plotly.moveTraces(self.$.plot, traceIndicesFrom, traceIndicesTo)
          .then(function (plotDiv) {
            // Update the polymer properties to reflect the updated data
            self.data = plotDiv.data;

            return self;
          });
      },

      /**
       * Clear all plots and snapshots.
       *
       * @return {Polymer.Base} the current element
       *
       * @see the {@link https://plot.ly/javascript/plotlyjs-function-reference/|plotly.js function reference}
       */
      purge: function () {
        Plotly.purge(this.$.plot);

        this.$.plot.data = [];
        this.data = [];

        this.$.plot.layout = {};
        this.layout = {};

        return this;
      },
    }
</script>